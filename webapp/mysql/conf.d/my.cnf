# 日本語（UTF-8）を正しく扱うための設定
[mysqld]
character-set-server = utf8mb4
collation-server = utf8mb4_unicode_ci
lower_case_table_names=1
secure_file_priv="/docker-entrypoint-initdb.d/csv"
max_allowed_packet=2G
disable-log-bin
performance_schema = OFF

slow_query_log = 0
slow_query_log_file = /var/log/mysql/mysql-slow.log
long_query_time = 0
log-queries-not-using-indexes

# 4G だとメモリを食い尽くした
# innodb_ft_result_cache_limit=4000000000

ngram_token_size=2
ft_min_word_len=2

# user@hostname と書けなくなるので注意
# skip-name-resolve

max_connections = 200

# システムメモリの 80% くらい
innodb_buffer_pool_size = 2G
innodb_buffer_pool_instances = 2

# 一時テーブルのサイズ上限
tmp_table_size = 64M
max_heap_table_size = 64M

sort_buffer_size = 2M
join_buffer_size = 2M
read_buffer_size = 2M
read_rnd_buffer_size = 8M

# 大きいと flush を遅らせられる
# innodb_log_file_size = 128M
innodb_redo_log_capacity = 1073741824   # 1 GiB
# 大きいと log 書き込みを減らせる
innodb_log_buffer_size = 64M

# 性能重視, クラッシュ時にデータロスの可能性あり
innodb_flush_log_at_trx_commit = 0
# OS のキャッシュをバイパス
innodb_flush_method = O_DIRECT
# 性能向上のため無効化, データ整合性リスクあり
innodb_doublewrite = 0
innodb_flush_log_at_timeout = 3

# バックグラウンドタスクの IOPS。ランダム IOPS の 50-75% を推奨
# 高すぎると余計な flush が増えるので性能が劣化
# innodb_io_capacity = 1000
# 読み書きスレッド数。ストレージの並列性と CPU のコア数に依存
innodb_read_io_threads = 8
innodb_write_io_threads = 8
# 同時実行可能なスレッド数 (0 は無制限)
innodb_thread_concurrency = 0
# AUTO_INCREMENT のロック制御モード。2 は連番が保証されない代わりに並列性が高い
# NOTE: order 作成時に飛ばれると困るので 1 にしておく
innodb_autoinc_lock_mode = 1

table_open_cache = 4000
table_definition_cache = 2000

thread_cache_size = 100

[mysqldump]
max_allowed_packet = 2G

[client]
default-character-set = utf8mb4
